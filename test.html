<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>World Pin Board - Flags Fill</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
             background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
             min-height:100vh;display:flex;flex-direction:column}
        .header{background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);padding:18px 20px;text-align:center}
        .header h1{color:white;font-size:2rem;margin-bottom:6px}
        .map-container{flex:1;position:relative;margin:18px;border-radius:14px;overflow:hidden}
        #map{height:72vh;min-height:540px}
        .stats-panel{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.95);padding:14px;border-radius:12px;z-index:1000}
        .reset-button{position:absolute;bottom:20px;right:20px;padding:12px 18px;border-radius:40px;border:none;background:linear-gradient(145deg,#ff6b6b,#ee5a52);color:white;cursor:pointer;z-index:1000}
        .instruction{position:absolute;bottom:20px;left:20px;background:rgba(255,255,255,0.95);padding:12px;border-radius:10px;z-index:1000}
        .country-hover{fill-opacity:.8 !important;stroke:#ffd700 !important;stroke-width:2 !important;filter:drop-shadow(0 4px 8px rgba(0,0,0,.25))}
    </style>
</head>
<body>
    <div class="header">
        <h1>üåç World Pin Board ‚Äî Click countries to fill with their flag</h1>
        <p style="color:rgba(255,255,255,0.9)">Click a country to mark it visited ‚Äî its flag will be painted inside the shape.</p>
    </div>

    <div class="map-container">
        <div id="map"></div>

        <div class="stats-panel">
            <h3>üìä Your Journey</h3>
            <div>Countries Visited: <strong id="visitedCount">0</strong></div>
            <div>Total Countries: <strong id="totalCount">0</strong></div>
            <div>Progress: <strong id="progressPercent">0%</strong></div>
        </div>

        <div class="instruction">üí° Tip: If flags don't load, run this file through a local web server (see instructions below).</div>

        <button class="reset-button" onclick="resetAllPins()">üîÑ Reset All Pins</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
    /************************************************************************
     * Key fixes:
     *  - ensure the <defs> is inserted INTO Leaflet's SVG (not a separate SVG)
     *  - create an SVG <pattern> that uses FlagCDN images (both href & xlink:href)
     *  - helpful console warnings if a country name -> iso code is missing
     ************************************************************************/

    let map;
    let visitedCountries = new Set();
    let countryLayers = {};
    let pins = {};

    // Map GeoJSON country names -> ISO alpha-2 code (lowercase)
    // NOTE: This covers common names found in most world.geojson files.
    const countryCodeMap = {
        "Afghanistan":"af","Albania":"al","Algeria":"dz","Andorra":"ad","Angola":"ao","Antigua and Barbuda":"ag",
        "Argentina":"ar","Armenia":"am","Australia":"au","Austria":"at","Azerbaijan":"az","Bahamas":"bs",
        "Bahrain":"bh","Bangladesh":"bd","Barbados":"bb","Belarus":"by","Belgium":"be","Belize":"bz","Benin":"bj",
        "Bhutan":"bt","Bolivia":"bo","Bosnia and Herzegovina":"ba","Botswana":"bw","Brazil":"br","Brunei":"bn",
        "Bulgaria":"bg","Burkina Faso":"bf","Burundi":"bi","Cabo Verde":"cv","Cape Verde":"cv","Cambodia":"kh","Cameroon":"cm",
        "Canada":"ca","Central African Republic":"cf","Chad":"td","Chile":"cl","China":"cn","Colombia":"co",
        "Comoros":"km","Congo (Brazzaville)":"cg","Congo (Kinshasa)":"cd","Republic of the Congo":"cg","Dem. Rep. Congo":"cd",
        "Costa Rica":"cr","Ivory Coast":"ci","C√¥te d'Ivoire":"ci","Croatia":"hr","Cuba":"cu","Cyprus":"cy","Czech Republic":"cz",
        "Czechia":"cz","Denmark":"dk","Djibouti":"dj","Dominica":"dm","Dominican Republic":"do","Ecuador":"ec",
        "Egypt":"eg","El Salvador":"sv","Equatorial Guinea":"gq","Eritrea":"er","Estonia":"ee","Eswatini":"sz","Swaziland":"sz",
        "Ethiopia":"et","Fiji":"fj","Finland":"fi","France":"fr","Gabon":"ga","Gambia":"gm","Georgia":"ge","Germany":"de",
        "Ghana":"gh","Greece":"gr","Grenada":"gd","Guatemala":"gt","Guinea":"gn","Guinea-Bissau":"gw","Guyana":"gy","Haiti":"ht",
        "Honduras":"hn","Hungary":"hu","Iceland":"is","India":"in","Indonesia":"id","Iran":"ir","Iraq":"iq","Ireland":"ie",
        "Israel":"il","Italy":"it","Jamaica":"jm","Japan":"jp","Jordan":"jo","Kazakhstan":"kz","Kenya":"ke","Kiribati":"ki",
        "Kuwait":"kw","Kyrgyzstan":"kg","Laos":"la","Laos People's Democratic Republic":"la","Latvia":"lv","Lebanon":"lb",
        "Lesotho":"ls","Liberia":"lr","Libya":"ly","Liechtenstein":"li","Lithuania":"lt","Luxembourg":"lu","Madagascar":"mg",
        "Malawi":"mw","Malaysia":"my","Maldives":"mv","Mali":"ml","Malta":"mt","Marshall Islands":"mh","Mauritania":"mr",
        "Mauritius":"mu","Mexico":"mx","Micronesia":"fm","Moldova":"md","Monaco":"mc","Mongolia":"mn","Montenegro":"me",
        "Morocco":"ma","Mozambique":"mz","Myanmar":"mm","Namibia":"na","Nauru":"nr","Nepal":"np","Netherlands":"nl",
        "New Zealand":"nz","Nicaragua":"ni","Niger":"ne","Nigeria":"ng","North Korea":"kp","Korea, Democratic People's Republic of":"kp",
        "North Macedonia":"mk","Macedonia":"mk","Norway":"no","Oman":"om","Pakistan":"pk","Palau":"pw","Palestine":"ps",
        "Panama":"pa","Papua New Guinea":"pg","Paraguay":"py","Peru":"pe","Philippines":"ph","Poland":"pl","Portugal":"pt",
        "Qatar":"qa","Romania":"ro","Russia":"ru","Russian Federation":"ru","Rwanda":"rw","Saint Kitts and Nevis":"kn",
        "Saint Lucia":"lc","Saint Vincent and the Grenadines":"vc","Samoa":"ws","San Marino":"sm","Sao Tome and Principe":"st",
        "Saudi Arabia":"sa","Senegal":"sn","Serbia":"rs","Seychelles":"sc","Sierra Leone":"sl","Singapore":"sg",
        "Slovakia":"sk","Slovenia":"si","Solomon Islands":"sb","Somalia":"so","South Africa":"za","South Korea":"kr",
        "Korea, Republic of":"kr","South Sudan":"ss","Spain":"es","Sri Lanka":"lk","Sudan":"sd","Suriname":"sr",
        "Sweden":"se","Switzerland":"ch","Syria":"sy","Syrian Arab Republic":"sy","Tajikistan":"tj","Tanzania":"tz",
        "Tanzania, United Republic of":"tz","Thailand":"th","Timor-Leste":"tl","Togo":"tg","Tonga":"to","Trinidad and Tobago":"tt",
        "Tunisia":"tn","Turkey":"tr","Turkmenistan":"tm","Tuvalu":"tv","Uganda":"ug","Ukraine":"ua","United Arab Emirates":"ae",
        "United Kingdom":"gb","United Kingdom of Great Britain and Northern Ireland":"gb","Great Britain":"gb",
        "United States of America":"us","United States":"us","USA":"us","US":"us","Uruguay":"uy","Uzbekistan":"uz",
        "Vanuatu":"vu","Vatican":"va","Holy See":"va","Venezuela":"ve","Viet Nam":"vn","Vietnam":"vn","Yemen":"ye",
        "Zambia":"zm","Zimbabwe":"zw"
    };

    // Initialize the map
    function initMap() {
        map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            maxZoom: 7,
            minZoom: 1,
            worldCopyJump: true
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        loadCountries();
    }

    // Load the GeoJSON and ensure <defs> is created inside Leaflet's SVG
    async function loadCountries() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson');
            const countries = await response.json();

            // Add GeoJSON to the map
            L.geoJSON(countries, {
                style: defaultStyle,
                onEachFeature: onEachFeature
            }).addTo(map);

            // Leaflet creates an <svg> element for vector layers; place our <defs> inside that svg.
            // Wait briefly for Leaflet's SVG to exist, then insert <defs> if needed.
            setTimeout(() => {
                const svg = document.querySelector('#map .leaflet-overlay-pane svg') || document.querySelector('#map svg');
                if (svg && !svg.querySelector('defs')) {
                    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    svg.insertBefore(defs, svg.firstChild);
                }
            }, 80);

            updateStats();
        } catch (err) {
            console.error('Failed to load world.geojson:', err);
            alert('Failed to load map data. Check console for details.');
        }
    }

    function defaultStyle() {
        return {
            fillColor: '#8FB3D3',
            weight: 1,
            opacity: 1,
            color: '#5F84A2',
            fillOpacity: 0.75
        };
    }

    function onEachFeature(feature, layer) {
        const countryName = feature.properties.name || feature.properties.NAME || feature.properties.ADMIN || 'Unknown';
        countryLayers[countryName] = layer;

        layer.on({
            mouseover(e) {
                if (!visitedCountries.has(countryName)) {
                    e.target.setStyle({ fillColor: '#FFD700', fillOpacity: 0.9, weight: 2, color: '#B8860B' });
                    if (e.target._path) e.target._path.classList.add('country-hover');
                }
            },
            mouseout(e) {
                if (!visitedCountries.has(countryName)) {
                    layer.setStyle(defaultStyle());
                    if (e.target._path) e.target._path.classList.remove('country-hover');
                }
            },
            click(e) {
                toggleCountry(countryName, layer);
            }
        });

        layer.bindTooltip(countryName, { permanent: false, direction: 'top' });
    }

    function toggleCountry(countryName, layer) {
        if (visitedCountries.has(countryName)) {
            // unvisit
            visitedCountries.delete(countryName);
            layer.setStyle(defaultStyle());
            if (pins[countryName]) { map.removeLayer(pins[countryName]); delete pins[countryName]; }
        } else {
            // visit
            visitedCountries.add(countryName);
            applyFlagImage(countryName, layer);
            addPin(countryName, layer);
        }
        updateStats();
    }

    // Ensure defs is inside Leaflet's SVG and return it
    function getMapDefs() {
        // try to find Leaflet's SVG then its defs
        const svg = document.querySelector('#map .leaflet-overlay-pane svg') || document.querySelector('#map svg');
        if (!svg) return null;
        let defs = svg.querySelector('defs');
        if (!defs) {
            defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            svg.insertBefore(defs, svg.firstChild);
        }
        return defs;
    }

    // Create/apply SVG pattern using FlagCDN image
    function applyFlagImage(countryName, layer) {
        const code = countryCodeMap[countryName];
        if (!code) {
            console.warn('No ISO code mapping for country:', countryName);
            // fallback to golden style
            layer.setStyle({ fillColor: '#D4AF37', fillOpacity: 0.7, weight: 2, color: '#B8860B' });
            return;
        }

        // Ensure defs exists (it should, but be defensive)
        const defs = getMapDefs();
        if (!defs) {
            console.warn('SVG defs not ready yet; retrying shortly for', countryName);
            setTimeout(() => applyFlagImage(countryName, layer), 120);
            return;
        }

        const patternId = `flag-pattern-${code}`;
        if (!defs.querySelector(`#${patternId}`)) {
            // Create pattern inside the map's SVG defs
            const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
            pattern.setAttribute('id', patternId);
            // objectBoundingBox makes the pattern scale to the shape bounding box
            pattern.setAttribute('patternUnits', 'objectBoundingBox');
            pattern.setAttribute('width', '1');
            pattern.setAttribute('height', '1');

            // Create image element inside pattern
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');

            // FlagCDN URL (we use the 320px wide PNG)
            const url = `https://flagcdn.com/w320/${code}.png`;

            // For compatibility: set both href and xlink:href
            image.setAttributeNS('http://www.w3.org/1999/xlink', 'href', url);
            image.setAttribute('href', url);

            // when using objectBoundingBox we use '1' dimensions (fills bounding box)
            image.setAttribute('width', '1');
            image.setAttribute('height', '1');
            image.setAttribute('preserveAspectRatio', 'xMidYMid slice');

            pattern.appendChild(image);
            defs.appendChild(pattern);
        }

        // Apply pattern as fill. Leaflet uses the "fill" attribute; set via fillColor option.
        layer.setStyle({
            fillColor: `url(#${patternId})`,
            fillOpacity: 1,
            color: '#222',
            weight: 1
        });
    }

    function getMainTerritoryCenter(countryName, layer) {
        // Basic approach: center of bounds (fine for pin placement)
        return layer.getBounds().getCenter();
    }

    function addPin(countryName, layer) {
        const center = getMainTerritoryCenter(countryName, layer);
        const pinIcon = L.divIcon({
            className: 'country-magnet',
            html: `<div style="background:white;border-radius:50%;padding:6px;box-shadow:0 6px 16px rgba(0,0,0,.15)">üìç</div>`,
            iconSize: [34, 34],
            iconAnchor: [17, 17]
        });

        const pin = L.marker(center, { icon: pinIcon, zIndexOffset: 1000 }).addTo(map);
        pin.bindPopup(`<div style="text-align:center"><strong>${countryName}</strong><div style="font-size:.9em;color:#666">Marked visited</div></div>`);
        pins[countryName] = pin;
    }

    function updateStats() {
        document.getElementById('visitedCount').textContent = visitedCountries.size;
        document.getElementById('totalCount').textContent = Object.keys(countryLayers).length;
        document.getElementById('progressPercent').textContent =
            Object.keys(countryLayers).length > 0 ? Math.round((visitedCountries.size / Object.keys(countryLayers).length) * 100) + '%' : '0%';
    }

    function resetAllPins() {
        if (!confirm('Reset all pins?')) return;
        visitedCountries.clear();
        Object.values(countryLayers).forEach(layer => layer.setStyle(defaultStyle()));
        Object.values(pins).forEach(pin => map.removeLayer(pin));
        pins = {};
        updateStats();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
